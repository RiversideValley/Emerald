# .github/workflows/CI.yml
name: CI Build & Artifacts

on:
  push:
    branches: [ main, release/** ]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, release/** ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.os != 'windows-latest' }}

    strategy:
      fail-fast: false 
      matrix:
        include:
          # == WINDOWS (WinUI 3 Unpackaged) ==
          - os: windows-latest
            platform: windows
            target_framework: 'net9.0-windows10.0.26100' 
            project_path: './Emerald/Emerald.csproj'
            # We will zip this folder later
            publish_output: 'Emerald_Windows'
            artifact_name: 'Emerald-Windows-Release'

          # == MACOS (Skia Desktop) ==
          - os: macos-latest
            platform: macos
            target_framework: 'net9.0-desktop' 
            project_path: './Emerald/Emerald.csproj'
            publish_output: 'Emerald_macOS'
            artifact_name: 'Emerald-macOS-Release'

          # == LINUX (Skia Gtk) ==
          - os: ubuntu-latest
            platform: linux
            target_framework: 'net9.0-desktop' 
            project_path: './Emerald/Emerald.csproj'
            publish_output: 'Emerald_Linux'
            artifact_name: 'Emerald-Linux-Release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 
        with:
          fetch-depth: 0 

      - name: Install Dependencies
        uses: ./.github/steps/install_dependencies 
        with:
          job-platform: ${{ matrix.platform }}

      - name: Setup MSBuild (Windows Only)
        uses: microsoft/setup-msbuild@v1.3.1
        if: matrix.os == 'windows-latest'

      # == BUILD STEP ==
      - name: Build and Publish (${{ matrix.platform }})
        shell: pwsh 
        run: |
          $project = "${{ matrix.project_path }}"
          $output = Join-Path $env:GITHUB_WORKSPACE "${{ matrix.publish_output }}"
          Write-Host "Building $project to $output..."

          if ('${{ matrix.platform }}' -eq 'windows') {
            # Windows WinUI 3 (Unpackaged & Self-Contained)
            msbuild $project /r /t:publish `
              /p:TargetFramework=${{ matrix.target_framework }} `
              /p:Configuration=Release `
              /p:Platform=x64 `
              /p:PublishDir="$output" `
              /p:WindowsPackageType=None `
              /p:WindowsAppSDKSelfContained=true `
              /p:SelfContained=true
          }
          elseif ('${{ matrix.platform }}' -eq 'macos') {
            # macOS (App Bundle)
            # PackageFormat=app creates a .app bundle structure
            dotnet publish $project -c Release -f "${{ matrix.target_framework }}" `
              -r osx-x64 --self-contained true `
              -p:PackageFormat=app `
              -o "$output"
          }
          else {
            # Linux (Standard Binary)
            dotnet publish $project -c Release -f "${{ matrix.target_framework }}" `
              -r linux-x64 --self-contained true `
              -o "$output"
          }

      # == ZIP STEP (Makes artifacts downloadable/runnable) ==
      - name: Zip Release Artifact
        shell: pwsh
        run: |
          $source = Join-Path $env:GITHUB_WORKSPACE "${{ matrix.publish_output }}"
          $zipName = "${{ matrix.artifact_name }}.zip"
          $destination = Join-Path $env:GITHUB_WORKSPACE $zipName
          
          Write-Host "Zipping $source to $destination"
          Compress-Archive -Path "$source\*" -DestinationPath $destination

      - name: Upload Artifact
        uses: actions/upload-artifact@v4 
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ github.workspace }}/${{ matrix.artifact_name }}.zip
          retention-days: 5