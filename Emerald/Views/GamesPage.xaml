<Page
    x:Class="Emerald.Views.GamesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:Emerald.Helpers"
    xmlns:cn="using:CommunityToolkit.WinUI.Controls"
    xmlns:conv="using:Emerald.Helpers.Converters"
    xmlns:corex="using:Emerald.CoreX"
    xmlns:corexVer="using:Emerald.CoreX.Versions"
    xmlns:corexIns="using:Emerald.CoreX.Installers"
    xmlns:uc="using:Emerald.UserControls"
    mc:Ignorable="d">

  <Page.Resources>

    
    <conv:BoolToVisibility x:Key="BoolToVis" />
    <conv:BoolToVisibility x:Key="InverseBoolToVis" Reversed="True" />
    <conv:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />

    <DataTemplate x:Key="GameItemTemplate" x:DataType="corex:Game">
      <cn:SettingsCard
                Margin="0,4"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
        <cn:SettingsCard.HeaderIcon>
          <FontIcon Glyph="&#xE7FC;" />
        </cn:SettingsCard.HeaderIcon>

        <cn:SettingsCard.Header>
          <StackPanel>
            <TextBlock
                            Text="{x:Bind Version.DisplayName}"
                            Style="{StaticResource BodyStrongTextBlockStyle}" />
            <TextBlock
                            Opacity="0.7"
                            Style="{StaticResource CaptionTextBlockStyle}">
                            <Run Text="{x:Bind Version.Type}" />
                            <Run Text="|" />
                            <Run Text="{x:Bind Version.BasedOn}" />
                            <Run Text="{x:Bind Version.ModVersion}" />
            </TextBlock>
          </StackPanel>
        </cn:SettingsCard.Header>

        <StackPanel
                    Orientation="Horizontal"
                    Spacing="8">
          <Button
                        Content="{helpers:FontIcon Glyph=&#xE768;}"
                        ToolTipService.ToolTip="Launch"
            x:Name="LaunchGame"
            Click="LaunchGame_Click"
                        Tag="{x:Bind}" />
          <Button
                        Tag="{x:Bind}" 
                        Content="{helpers:FontIcon Glyph=&#xE896;}"
                        ToolTipService.ToolTip="Install/Update"
            Click="InstallGame_Click"/>
          <DropDownButton
                        Content="{helpers:FontIcon Glyph=&#xE712;}"
                        ToolTipService.ToolTip="More Options">
            <DropDownButton.Flyout>
              <MenuFlyout Placement="Bottom">
                <MenuFlyoutItem
                                    Text="Manage Settings"
                                    Icon="{helpers:FontIcon Glyph=&#xE713;}"
                                    Click="ManageSettings_Click"
                                    Tag="{x:Bind}" />
                <MenuFlyoutSeparator />
                <MenuFlyoutItem
                                    Text="Open Folder"
                                    Icon="{helpers:FontIcon Glyph=&#xE8B7;}"
                                    Click="OpenFolder_Click"
                                    Tag="{x:Bind}" />
                <MenuFlyoutSeparator />
                <MenuFlyoutItem
                                    Text="Remove"
                                    Icon="{helpers:FontIcon Glyph=&#xE74D;}"
                                    Command="{Binding ElementName=RootPage, Path=ViewModel.RemoveGameCommand}"
                                    CommandParameter="{x:Bind}" />
                <MenuFlyoutItem
                                    Text="Remove with Files"
                                    Icon="{helpers:FontIcon Glyph=&#xE74D;}"
                                    Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                    Command="{Binding ElementName=RootPage, Path=ViewModel.RemoveGameWithFilesCommand}"
                                    CommandParameter="{x:Bind}" />
              </MenuFlyout>
            </DropDownButton.Flyout>
          </DropDownButton>
        </StackPanel>
      </cn:SettingsCard>
    </DataTemplate>
  </Page.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Header -->
    <Grid
            Grid.Row="0"
            Padding="24,24,24,12">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <StackPanel Grid.Column="0">
        <TextBlock
                    Text="Games"
                    Style="{StaticResource TitleTextBlockStyle}" />
        <TextBlock
                    Text="Manage your Minecraft game instances"
                    Style="{StaticResource CaptionTextBlockStyle}"
                    Opacity="0.7" />
      </StackPanel>

      <CommandBar
                Grid.Column="1"
                Background="Transparent"
                DefaultLabelPosition="Right"
                OverflowButtonVisibility="Collapsed">
        <AppBarButton
                    Icon="Add"
                    Label="Add Game"
                    Click="AddGame_Click" />
        <AppBarButton
                    Icon="Refresh"
                    Label="Refresh"
                    Command="{x:Bind ViewModel.RefreshGamesCommand}" />
      </CommandBar>
    </Grid>

    <!-- Content -->
    <Grid
            Grid.Row="1"
            Margin="24,0,24,24">

      <!-- Search Box -->
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <AutoSuggestBox
                Grid.Row="0"
                Margin="0,0,0,12"
                PlaceholderText="Search games..."
                QueryIcon="Find"
                Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay}"
                HorizontalAlignment="Stretch"
                MaxWidth="400" />

      <!-- Games List -->
      <ScrollViewer
                Grid.Row="1"
                VerticalScrollBarVisibility="Auto">

        <Grid>
          <!-- Loading State -->
          <StackPanel
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="12"
                        Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVis}}">
            <ProgressRing IsActive="True" />
            <TextBlock Text="Loading games..." />
          </StackPanel>

          <!-- Empty State -->
          <StackPanel
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="12"
                        Visibility="{x:Bind Path=ViewModel.FilteredGames.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=0}">
            <FontIcon
                            FontSize="48"
                            Glyph="&#xE7FC;"
                            Opacity="0.5" />
            <TextBlock
                            Text="No games found"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            HorizontalAlignment="Center" />
            <TextBlock
                            Text="Click 'Add Game' to create your first game instance"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            HorizontalAlignment="Center"
                            Opacity="0.7" />
            <Button
                            Content="Add Game"
                            HorizontalAlignment="Center"
                            Click="AddGame_Click"
                            Style="{ThemeResource AccentButtonStyle}" />
          </StackPanel>

          <!-- Games List -->
          <ItemsRepeater
                        ItemsSource="{x:Bind ViewModel.FilteredGames, Mode=OneWay}"
                        ItemTemplate="{StaticResource GameItemTemplate}"
                        Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVis}}">
            <ItemsRepeater.Layout>
              <StackLayout Spacing="4" />
            </ItemsRepeater.Layout>
          </ItemsRepeater>
        </Grid>
      </ScrollViewer>
    </Grid>

    <!-- Add Game Dialog -->
    <ContentDialog
            x:Name="AddGameDialog"
            Title="Add New Game"
            PrimaryButtonText="Create"
            SecondaryButtonText="Cancel"
            DefaultButton="Primary"
            IsPrimaryButtonEnabled="{x:Bind ViewModel.IsCreateButtonEnabled, Mode=OneWay}">

      <ScrollViewer>
        <StackPanel Spacing="16" MinWidth="400">

          <!-- Game Name -->
          <TextBox
                        Header="Game Name"
                        PlaceholderText="Enter a unique name for this instance"
                        Text="{x:Bind ViewModel.NewGameName, Mode=TwoWay}" />

          <!-- Minecraft Version -->
          <ComboBox
                        Header="Minecraft Version"
                        PlaceholderText="Select a version"
                        ItemsSource="{x:Bind ViewModel.AvailableVersions}"
                        SelectedItem="{x:Bind ViewModel.SelectedVersion, Mode=TwoWay}"
                        SelectionChanged="VersionComboBox_SelectionChanged"
                        HorizontalAlignment="Stretch">
            <ComboBox.ItemTemplate>
              <DataTemplate x:DataType="corexVer:Version">
                <StackPanel>
                  <TextBlock Text="{x:Bind BasedOn}" />
                  <TextBlock
                                        Text="{x:Bind ReleaseType}"
                                        FontSize="12"
                                        Opacity="0.7" />
                </StackPanel>
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>

          <!-- Mod Loader Type -->
          <ComboBox
                        Header="Mod Loader (Optional)"
                        SelectedIndex="0"
                        SelectionChanged="ModLoaderType_SelectionChanged"
                        HorizontalAlignment="Stretch">
            <ComboBoxItem Content="Vanilla (No mods)" Tag="Vanilla" />
            <ComboBoxItem Content="Fabric" Tag="Fabric" />
            <ComboBoxItem Content="Forge" Tag="Forge" />
            <ComboBoxItem Content="Quilt" Tag="Quilt" />
            <ComboBoxItem Content="OptiFine" Tag="OptiFine" />
            <ComboBoxItem Content="LiteLoader" Tag="LiteLoader" />
          </ComboBox>

          <!-- Mod Loader Version -->
          <ComboBox
                        x:Name="ModLoaderVersionComboBox"
                        Header="Mod Loader Version"
                        PlaceholderText="Select a version"
                        ItemsSource="{x:Bind ViewModel.AvailableModLoaders}"
                        SelectedItem="{x:Bind ViewModel.SelectedModLoader, Mode=TwoWay}"
                        HorizontalAlignment="Stretch"
                        Visibility="Collapsed">
            <ComboBox.ItemTemplate>
              <DataTemplate x:DataType="corexIns:LoaderInfo">
                <TextBlock Text="{x:Bind Version}" />
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>

          <!-- Loading Indicator -->
          <ProgressBar
                        IsIndeterminate="True"
                        Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVis}}" />

        </StackPanel>
      </ScrollViewer>
    </ContentDialog>

    <!-- Settings Dialog -->
    <ContentDialog
      x:Name="SettingsDialog"
      Title="Game Settings"
      PrimaryButtonText="Save">
      <Grid>
        <ScrollViewer>
          <uc:MinecraftSettingsUC
                            x:Name="GameSettingsControl"
                            ShowMainSettings="False" />
        </ScrollViewer>
      </Grid>
    </ContentDialog>

  </Grid>
</Page>
